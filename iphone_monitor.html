<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRAMPS - iPhone IMU Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .status {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .status.waiting {
            background-color: #f0f0f0;
            color: #666;
        }

        .status.connected {
            background-color: #4caf50;
            color: white;
        }

        .status.disconnected {
            background-color: #f44336;
            color: white;
        }

        .status.warning {
            background-color: #ff9800;
            color: white;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box p {
            margin: 5px 0;
            color: #1976d2;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .config-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .sensor-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #4caf50;
        }

        .sensor-card h3 {
            color: #4caf50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .sensor-value {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }

        .sensor-label {
            font-weight: bold;
            color: #555;
        }

        .sensor-data {
            font-family: 'Courier New', monospace;
            color: #333;
            font-size: 1.1em;
        }

        .error-message {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ BRAMPS</h1>
        <p class="subtitle">iPhone IMU Data Monitor</p>

        <div id="status" class="status waiting">Status: Waiting for iPhone connection...</div>

        <div class="info-box">
            <p><strong>iPhone IMU Data Display</strong></p>
            <p>This page displays real-time sensor data from your iPhone IMU Utility App.</p>
            <p>Configure your iPhone app: Host: <strong>10.75.173.146</strong>, UDP Port: <strong>65000</strong>, Format: <strong>JSON</strong></p>
        </div>

        <div id="errorContainer"></div>

        <div class="config-section">
            <h3>Server Information</h3>
            <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 5px; padding: 15px;">
                <p><strong>üñ•Ô∏è Server:</strong> <code id="server-display">http://10.75.173.146:5000</code></p>
                <p><strong>üìä Status:</strong> <span id="connection-status">Checking connection...</span></p>
                <button onclick="testConnection()" style="padding: 8px 15px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                    üîç Test Connection
                </button>
                <span id="connection-test-result" style="margin-left: 10px;"></span>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin-top: 15px;">
                <strong>üì± iPhone App Settings:</strong><br>
                ‚Ä¢ Host/IP: <code>10.75.173.146</code><br>
                ‚Ä¢ UDP Port: <code>65000</code><br>
                ‚Ä¢ Data Format: <code>JSON</code><br>
                ‚Ä¢ Rate: <code>10 Hz</code> (recommended)
            </div>
        </div>

        <div class="sensor-grid">
            <div class="sensor-card">
                <h3>üì± Accelerometer (iPhone)</h3>
                <div class="sensor-value">
                    <span class="sensor-label">X:</span>
                    <span class="sensor-data" id="iphone_accel_x">--</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Y:</span>
                    <span class="sensor-data" id="iphone_accel_y">--</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Z:</span>
                    <span class="sensor-data" id="iphone_accel_z">--</span>
                </div>
            </div>

            <div class="sensor-card">
                <h3>üîÑ Gyroscope (iPhone)</h3>
                <div class="sensor-value">
                    <span class="sensor-label">X:</span>
                    <span class="sensor-data" id="iphone_gyro_x">--</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Y:</span>
                    <span class="sensor-data" id="iphone_gyro_y">--</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Z:</span>
                    <span class="sensor-data" id="iphone_gyro_z">--</span>
                </div>
            </div>

            <div class="sensor-card">
                <h3>üß≤ Magnetometer (iPhone)</h3>
                <div class="sensor-value">
                    <span class="sensor-label">X:</span>
                    <span class="sensor-data" id="iphone_mag_x">--</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Y:</span>
                    <span class="sensor-data" id="iphone_mag_y">--</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Z:</span>
                    <span class="sensor-data" id="iphone_mag_z">--</span>
                </div>
            </div>
        </div>

        <div class="sensor-card">
            <h3>üìä Server Statistics</h3>
            <div class="sensor-value">
                <span class="sensor-label">Total Packets Received:</span>
                <span class="sensor-data" id="server_total_packets">0</span>
            </div>
            <div class="sensor-value">
                <span class="sensor-label">UDP Packets:</span>
                <span class="sensor-data" id="server_udp_packets">0</span>
            </div>
            <div class="sensor-value">
                <span class="sensor-label">Packets/Second:</span>
                <span class="sensor-data" id="server_packets_per_sec">0</span>
            </div>
            <div class="sensor-value">
                <span class="sensor-label">Last iPhone Update:</span>
                <span class="sensor-data" id="iphone_last_update">Never</span>
            </div>
        </div>
    </div>

    <script>
        // Hardcoded server URL - automatically connects to your server
        const SERVER_URL = 'http://10.75.173.146:5000';
        let iphoneDataInterval = null;
        
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">‚ö†Ô∏è ${message}</div>`;
        }

        function clearError() {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = '';
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `Status: ${message}`;
            statusEl.className = `status ${type}`;
        }

        function updateConnectionStatus(message, type) {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = message;
            statusEl.style.color = type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#666';
        }

        function testConnection() {
            const resultEl = document.getElementById('connection-test-result');
            
            resultEl.textContent = '‚è≥ Testing...';
            resultEl.style.color = '#666';
            updateConnectionStatus('Testing connection...', 'info');
            
            fetch(`${SERVER_URL}/health`)
                .then(response => response.json())
                .then(data => {
                    resultEl.textContent = '‚úÖ Server reachable!';
                    resultEl.style.color = '#4caf50';
                    updateConnectionStatus('‚úÖ Server online and reachable', 'success');
                    clearError();
                })
                .catch(error => {
                    resultEl.textContent = '‚ùå Cannot reach server';
                    resultEl.style.color = '#f44336';
                    updateConnectionStatus('‚ùå Server unreachable', 'error');
                    showError(`Connection test failed: ${error.message}. Make sure the server is running.`);
                });
        }
        
        function fetchiPhoneData() {
            console.log('Fetching iPhone data from:', SERVER_URL);
            
            // Get server stats
            fetch(`${SERVER_URL}/stats`)
                .then(response => response.json())
                .then(stats => {
                    document.getElementById('server_total_packets').textContent = stats.total_packets || 0;
                    document.getElementById('server_udp_packets').textContent = stats.udp_packets || 0;
                    document.getElementById('server_packets_per_sec').textContent = (stats.packets_per_second || 0).toFixed(2);
                    
                    // Update connection status based on UDP data
                    if (stats.udp_recent === true) {
                        // UDP data received in last 5 seconds
                        updateStatus('Connected - Receiving data from iPhone', 'connected');
                        clearError();
                    } else if (stats.last_udp_time) {
                        // UDP data received before, but not recently
                        const timeSince = stats.time_since_last_udp || 0;
                        if (timeSince < 30) {
                            updateStatus(`Last data ${Math.round(timeSince)}s ago`, 'warning');
                        } else {
                            updateStatus('Disconnected - No recent data', 'disconnected');
                        }
                    } else {
                        // No UDP data ever received
                        updateStatus('Waiting for iPhone connection...', 'waiting');
                    }
                })
                .catch(error => {
                    console.error('Error fetching stats:', error);
                    updateStatus('Error connecting to server', 'disconnected');
                    showError('Cannot connect to server. Make sure the server is running.');
                });
            
            // Get recent data (last packet)
            fetch(`${SERVER_URL}/recent?limit=1`)
                .then(response => response.json())
                .then(result => {
                    console.log('Recent data response:', result);
                    if (result.data && result.data.length > 0) {
                        const latestData = result.data[result.data.length - 1];
                        console.log('Latest data:', latestData);
                        
                        // Update iPhone sensor displays
                        if (latestData.accel_x !== undefined) {
                            document.getElementById('iphone_accel_x').textContent = latestData.accel_x.toFixed(2);
                            document.getElementById('iphone_accel_y').textContent = latestData.accel_y.toFixed(2);
                            document.getElementById('iphone_accel_z').textContent = latestData.accel_z.toFixed(2);
                        }
                        
                        if (latestData.gyro_x !== undefined) {
                            document.getElementById('iphone_gyro_x').textContent = latestData.gyro_x.toFixed(2);
                            document.getElementById('iphone_gyro_y').textContent = latestData.gyro_y.toFixed(2);
                            document.getElementById('iphone_gyro_z').textContent = latestData.gyro_z.toFixed(2);
                        }
                        
                        if (latestData.mag_x !== undefined) {
                            document.getElementById('iphone_mag_x').textContent = latestData.mag_x.toFixed(2);
                            document.getElementById('iphone_mag_y').textContent = latestData.mag_y.toFixed(2);
                            document.getElementById('iphone_mag_z').textContent = latestData.mag_z.toFixed(2);
                        }
                        
                        // Update last update time
                        if (latestData.server_received_at) {
                            const updateTime = new Date(latestData.server_received_at);
                            document.getElementById('iphone_last_update').textContent = updateTime.toLocaleTimeString();
                        }
                    } else {
                        console.log('No recent data found');
                    }
                })
                .catch(error => {
                    console.error('Error fetching iPhone data:', error);
                });
        }
        
        function startiPhoneDataPolling() {
            // Poll every 1 second
            if (iphoneDataInterval) {
                clearInterval(iphoneDataInterval);
            }
            iphoneDataInterval = setInterval(fetchiPhoneData, 1000);
            // Fetch immediately
            fetchiPhoneData();
        }
        
        function stopiPhoneDataPolling() {
            if (iphoneDataInterval) {
                clearInterval(iphoneDataInterval);
                iphoneDataInterval = null;
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            // Test connection on startup
            testConnection();
            
            // Start polling for iPhone data automatically
            startiPhoneDataPolling();
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopiPhoneDataPolling();
        });
    </script>
</body>
</html>
